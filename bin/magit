#!/bin/bash

function start-emacs() {
	set +e
	emacs-client "$@"
	if [[ $? == 1 ]]
	then
		echo "Starting Emacs."
		activate-emacs
		wait-for-emacs "$@"
	fi
	set -e
	activate-emacs
}

function wait-for-emacs() {
	echo -n "Waiting for emacs-server"
	until emacs-client "$@"
	do 
		# Interactively adding . at the end of Emacs?
		echo -n "."
		sleep 0.5
	done
	echo
}

function emacs-client() {
	emacsclient -n "$@" > /dev/null 2>&1
}

function magit() {
	# Check for dependencies
	if hash emacsclient 2>/dev/null
	then :
	else
		echo "No emacsclient available"
		exit 3
	fi

	set -e

	# Get paths
	p="$(pwd)"
	WD="$(cd "$1" || exit ; pwd -P)"
	# Check if directory was provided
	if [ -n "$WD" ]
	then
		cd "$WD"
		git status > /dev/null
		start-emacs --eval '(magit-status)'
		cd "$p"
	fi
}

magit "$@"
