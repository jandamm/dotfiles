#!/usr/bin/env bash

# Helper functions {{{

function quit_setup() {
	echo "Usage:"
	echo "  dotfile-setup 'mode'"
	echo "Modes: install & update"
	exit 1
}

function load_env_if_needed() {
	if [ -z "$DOTFILES" ]
	then
		echo "Not yet set up. Sourcing zshenv"
		# shellcheck source=../zshenv
		source "$(pwd)/${0%/*}/../zshenv"
	fi
}

# }}}

if [ ! $# -eq 1 ]
then quit_setup
fi

case $1 in
	install)
		should_install=true;;
	update)
		should_update=true;;
	*)
		quit_setup
esac
shift

load_env_if_needed

cd "$DOTFILES" || exit

# put every dotfile in place
if [ "$should_install" ]; then
	env RCRC="$DOTFILES/rcrc" rcup
fi

# Install Brewfile {{{

echo 'Install Brewfile'
if [ "$should_install" ] || [ "$should_update" ]; then
	brew bundle install --global
fi

# }}}

# Install pips {{{

echo 'Install pips'
if [ "$should_install" ]; then
	pip3 install -r "$DOTFILES/pip3-requirements"
fi
if [ "$should_update" ]; then
	pip3 install -U -r "$DOTFILES/pip3-requirements"
fi

# }}}


# ALACRITTY {{{

if [ "$should_install" ]; then
	# Set font rendering for non retina
	defaults write -g CGFontRenderingFontSmoothingDisabled -bool NO
fi

# }}}

# BAT {{{

if [ "$should_install" ]; then
	# recompile with theme
	bat cache --build
fi

# }}}

# NVIM {{{

if [ "$should_install" ]; then
	nvim -u vim/plugins.vim +PlugInstall +qa
	for file in vim/spell/*.add
	do
		nvim "+mkspell! $file" +qa
	done
fi

if [ "$should_update" ]; then
	nvim -u vim/plugins.vim +PlugUpgrade +PlugUpdate +qa
fi

# }}}

# TMUX {{{

# install tmux terminal
if [ "$should_install" ]; then
	if [[ ! -x  "$DOTFILES_CACHE/tmux/plugins/tpm/tpm" ]]
	then git clone https://github.com/tmux-plugins/tpm "$DOTFILES_CACHE/tmux/plugins/tpm"
	fi
	"$DOTFILES_CACHE"/tmux/plugins/tpm/bin/install_plugins
fi
if [ "$should_update" ]; then
	"$DOTFILES_CACHE"/tmux/plugins/tpm/bin/update_plugins all
fi

# }}}

# ZSH {{{

# if [ "$should_install" ]; then
# rezsh
# zinit module build
# mkdir $HOME/.cache/zsh
# fi
# if [ "$should_update" ]; then
# zinit update
# fi

# }}}

rcup

# vim:set foldmethod=marker:
