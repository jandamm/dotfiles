#!/usr/bin/env zsh

set -e
zparseopts -D -E i=interactive -interactive=interactive

if [[ $1 = 'apply' ]]; then
	shift
	sha=$1

	if [[ -z ${interactive[1]:-} && -z $sha ]]; then
		branch="$(git remote | head -n 1)/$(git branch --show-current)"
		if git show-branch "$branch" &>/dev/null; then
			sha="$branch"
		fi
	fi

	: ${sha:=$(git logf --prompt='Fixup> ' --header='Select the oldest commit before a fixed commit.')}

	GIT_SEQUENCE_EDITOR=true git rebase --interactive --autosquash "${sha%% *}"
	exit
fi

sha=${1:-$(git logf --prompt='Fixup> ')}

git commit --fixup "${sha%% *}"
