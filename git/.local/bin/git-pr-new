#!/bin/bash

set -euo pipefail

if [ -n "$(git status --porcelain)" ]; then
    echo "Stash before using this script." 2>&1
    exit
fi

if ! git fetch origin main ; then
    default=main
elif ! git fetch origin develop ; then
    default=develop
else
    default=master
    git fetch origin $default
fi

readonly pr_commit="${1:-$default}"

# Autogenerate a branch name based on the commit subject.
readonly branch_name="$(git show --no-patch --format="%f" "$pr_commit")"

# Create the new branch and switch to it.
git branch --no-track "$branch_name" origin/$default
git switch "$branch_name"

# Cherry pick the desired commit.
if ! git cherry-pick "$pr_commit"; then
    git cherry-pick --abort
    git switch $default
    git branch -d "$branch_name"
    printf '\033[0;31mCould not cherry-pick commit. There is probably a dependency to a previous commit.\n'
    exit 1
fi

git-pr-open --push

# Go back to $default branch.
git switch $default
